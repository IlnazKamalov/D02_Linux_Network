## Part 1. Инструмент **ipcalc**

## 1.1. Сети и маски
## Определить и записать в отчёт:
## 1) адрес сети *192.167.38.54/13*

ipcalc 192.167.38.54/13
![part1](/src/screen/1.1.png)
## 2) перевод маски *255.255.255.0* в префиксную и двоичную запись

- префикс -/24, двоичная запись - 11111111.11111111.11111111.00000000.

## */15* в обычную и двоичную 

- нормализованный вид - 255.254.0.0, двоичная - 11111111.11111110.00000000.00000000.

## *11111111.11111111.11111111.11110000* в обычную и префиксную

- обычная - 255.255.255.240, префиксная - /28

## 3) минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

- При маске /8 (255.0.0.0):

- Минимальный хост: 12.0.0.1
- Максимальный хост: 12.255.255.254

## 1.2. localhost
## Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

![part1](/src/screen/1.2.1.png)
При пинговании ип адреса 194.34.23.100 соединение отсутствует.
Невозможно обратиться к ип адресу т.к. нет соединения.

![part1](/src/screen/1.2.2.png)
При пинговании ип адреса 127.0.0.2 соединение присутствует.

![part1](/src/screen/1.2.3.png)
При пинговании ип адреса 127.1.0.1 соединение присутствует.

![part1](/src/screen/1.2.4.png)
При пинговании ип адреса 128.0.0.1 соединение отсутствует.
Невозможно обратиться к ип адресу т.к. нет соединения.

## 1.3. Диапазоны и сегменты сетей
## Определить и записать в отчёт:
## 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

К частным "серым" адресам относятся IP-адреса из следующих подсетей: От 10.0.0.0 до 10.255.255.255 с маской 255.0.0.0 или /8. От 172.16.0.0 до 172.31.255.255 с маской 255.240.0.0 или /12. От 192.168.0.0 до 192.168.255.255 с маской 255.255.0.0 или /16.

- частные 10.0.0.45, 172.20.250.4, 172.16.255.255, 10.10.10.10,
192.168.4.2.
- публичные 134.43.0.2, 172.0.2.1, 192.169.168.1, 192.172.0.1, 172.68.0.2.

## 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

![part2](/src/screen/ipcalc.png)

## Part 2. Статическая маршрутизация между двумя машинами

## Поднять две виртуальные машины

![part2](/src/screen/2.png)

## С помощью команды `ip a` посмотреть существующие сетевые интерфейсы

1 машина
![part2](/src/screen/2.1.png)

2 машина
![part2](/src/screen/2.2.png)

## На обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

## В отчёт поместить скрины с содержанием изменённого файла etc/netplan/00-installer-config.yaml для каждой машины.

![part2](/src/screen/2.3.png)

![part2](/src/screen/2.4.png)

## Выполнить команду netplan apply для перезапуска сервиса сети

![part2](/src/screen/21.png)
![part2](/src/screen/22.png)

## 2.1. Добавление статического маршрута вручную

## Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`. Пропинговать соединение 

![part2](/src/screen/1vmping.png)
![part2](/src/screen/2vmping.png)

## Пропингованные соединения

![part2](/src/screen/23.png)
![part2](/src/screen/24.png)

## 2.2. Добавление статического маршрута с сохранением

## Перезапустить машины

## Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

![part2](/src/screen/25.png)
![part2](/src/screen/26.png)

## Пропинговать соединение

![part2](/src/screen/23.png)
![part2](/src/screen/24.png)

## Part 3. Утилита iperf3

## 3.1. Скорость соединения

## Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

- 8 Mbps (мегабит в секуду) = 1 MB/s (мегабайт в секунду)
- 100 MB/s (мегабайт в секунду) = 800 000 Kbps (килобит в секунду)
- 1 Gbps (гигабит в секунду) = 1 000 Mbps (мегабит в секунду)

## Утилита iperf3

## Измерить скорость соединения между ws1 и ws2

![part2](/src/screen/31.png)
![part2](/src/screen/32.png)

## Part 4. Сетевой экран

## 4.1. Утилита iptables

## Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:

![part2](/src/screen/41.png)
![part2](/src/screen/42.png)

## Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh

ws1:
![part2](/src/screen/43.png)

ws2:
![part2](/src/screen/44.png)

## В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах.

- В первом файле на ws1 применена стратегия, где в начале указываются запрещающие правила (DROP) для вывода (OUTPUT) данных, а затем разрешающие правила (ACCEPT) для ввода (INPUT) данных. Это означает, что машина ws1 блокирует исходящие (ответные) ICMP-сообщения, что делает ее непингуемой (не реагирует на пинги).

- Во втором файле на ws2 применена стратегия, где в начале указываются разрешающие правила (ACCEPT) для ввода (INPUT) данных, а затем запрещающие правила (DROP) для вывода (OUTPUT) данных. Это означает, что машина ws2 разрешает входящие ICMP-сообщения (пинги), но блокирует исходящие ICMP-сообщения (ответы на пинги).

## 4.2. Утилита nmap

## Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен

ws2:
![part2](/src/screen/45.png)

ws1:
![part2](/src/screen/46.png)

nmap:
![part2](/src/screen/47.png)

## Сохранить дампы образов виртуальных машин

ws1:

![part2](/src/screen/48.png)

![part2](/src/screen/50.png)

ws2:

![part2](/src/screen/49.png)

![part2](/src/screen/50.png)

## 5. Статическая маршрутизация сети

## 5.1. Настройка адресов машин

## Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.

r1:

![part2](/src/screen/53.png)

r2:

![part2](/src/screen/54.png)

ws11:

![part2](/src/screen/55.png)

ws21:

![part2](/src/screen/56.png)

ws22:

![part2](/src/screen/57.png)


## Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

r1:

![part2](/src/screen/58.png)

r2:

![part2](/src/screen/59.png)

ws11:

![part2](/src/screen/60.png)

ws21:

![part2](/src/screen/61.png)

ws22:

![part2](/src/screen/62.png)

Ping r1 ws11:

![part2](/src/screen/63.png)

Ping ws22 ws21:

![part2](/src/screen/64.png)


## 5.2. Включение переадресации IP-адресов.

r1 - sysctl -w net.ipv4.ip_forward=1

![part2](/src/screen/65.png)

r2 - sysctl -w net.ipv4.ip_forward=1

![part2](/src/screen/66.png)

## Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:

## net.ipv4.ip_forward = 1. При использовании этого подхода, IP-переадресация включена на постоянной основе.

r1 - /etc/sysctl.conf

![part2](/src/screen/67.png)

r2 - /etc/sysctl.conf

![part2](/src/screen/68.png)


## 5.3. Установка маршрута по-умолчанию

## Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций

ws11 config

![part2](/src/screen/69.png)

ws21 config

![part2](/src/screen/70.png)

ws22 config

![part2](/src/screen/71.png)


## Вызвать ip r и показать, что добавился маршрут в таблицу маршрутизации

ws11 - ip r

![part2](/src/screen/72.png)

ws21 - ip r

![part2](/src/screen/73.png)

ws22 - ip r

![part2](/src/screen/74.png)

## Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: tcpdump -tn -i eth1

ping ws11

![part2](/src/screen/75.png)

listen ping r2

![part2](/src/screen/76.png)

## 5.4. Добавление статических маршрутов

## Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.

r1 config

![part2](/src/screen/77.png)

r1 config

![part2](/src/screen/78.png)

## Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.

r1 config


![part2](/src/screen/79.png)

r1 config


![part2](/src/screen/80.png)

## Запустить команды на ws11:

## ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0

![part2](/src/screen/81.png)

## В отчёте объяснить, почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию.

- Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0 (он попадает под маршрут по-умолчанию), т.к. машина ws11 соединена с сетью 10.10.0.0/18 по своему IP-адресу 10.10.0.2, для других адресов используется маршрут по умолчанию, который указан в файле 10.10.0.1.

## 5.5. Построение списка маршрутизаторов

## Запустить на r1 команду дампа

tcpdump -tnv -i enp0s8

![part2](/src/screen/82.png)

## При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21

![part2](/src/screen/83.png)

## В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи traceroute.

- Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.
- Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

## 5.6. Использование протокола ICMP при маршрутизации

## Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: tcpdump -n -i eth0 icmp

r1 listen

![part2](/src/screen/84.png)

## Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды ping -c 1 10.30.0.111

ws11 ping

![part2](/src/screen/85.png)

## 6. Динамическая настройка IP с помощью DHCP

## Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

## 1: указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2

dhcpd.conf r2

![part2](/src/screen/86.png)

## 2: в файле resolv.conf прописать nameserver 8.8.8.8.

resolv.conf

![part2](/src/screen/87.png)

## Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21

systemctl restart isc-dhcp-server

![part2](/src/screen/88.png)

ip a ws21

![part2](/src/screen/89.png)

ip a ws22

![part2](/src/screen/90.png)

ping ws22 from ws21

![part2](/src/screen/91.png)

## Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true

config ws11

![part2](/src/screen/92.png)

## Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

r1 dhcpd.conf

![part2](/src/screen/93.png)

r1 resolv.conf

![part2](/src/screen/94.png)

r1 restart

![part2](/src/screen/95.png)

ip a ws11

![part2](/src/screen/96.png)

## Запросить с ws21 обновление ip адреса

До ws21

![part2](/src/screen/97.png)

Запросим с ws21 обновление ip адреса с помощью команды sudo dhclient -v

![part2](/src/screen/98.png)

Выполним команду для удаления старого IP адреса sudo dhclient -r

![part2](/src/screen/99.png)

После ws21

![part2](/src/screen/100.png)

## 7. NAT

## В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным

r1 config

![part2](/src/screen/101.png)

ws22 config

![part2](/src/screen/102.png)

## Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

r1 start

![part2](/src/screen/103.png)

ws22 start

![part2](/src/screen/104.png)

## Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

## удаление правил в таблице filter - iptables -F

## удаление правил в таблице "NAT" - iptables -F -t nat

## отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

r2 firewall config

![part2](/src/screen/105.png)

r2 firewall start

![part2](/src/screen/106.png)

Соединение между ws22 и r1


![part2](/src/screen/107.png)


![part2](/src/screen/108.png)

## Добавить в файл ещё одно правило:

## разрешить маршрутизацию всех пакетов протокола ICMP

firewall config r2

![part2](/src/screen/109.png)

![part2](/src/screen/110.png)

## Добавить в файл ещё два правила:

## включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

## включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

firewall config r2

![part2](/src/screen/111.png)

## Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой: telnet адрес порт

telnet ws22

![part2](/src/screen/112.png)


## Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)

telnet r1

![part2](/src/screen/113.png)

## 8. Дополнительно. Знакомство с SSH Tunnels

## Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![part2](/src/screen/114.png)

## Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![part2](/src/screen/115.png)

## Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![part2](/src/screen/116.png)

## Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`

![part2](/src/screen/117.png)